<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative School of Art</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .main-container {
            max-width: 420px;
            height: 850px;
            border-radius: 2rem;
            transition: background-color 0.3s ease;
        }
        .page { display: none; }
        .page.active { display: block; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #2d3748; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #718096; }
        .status-paid { background-color: #10B981; color: white; }
        .status-due { background-color: #EF4444; color: white; }
        .status-normal { background-color: #A0AEC0; color: white; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .id-card-bg { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .dark .id-card-bg { background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%); }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 40;
        }
        #modal-container { z-index: 50; }

        /* Theme Styles */
        .theme-indigo .theme-gradient { background-image: linear-gradient(to right, #6366f1, #4f46e5); }
        .theme-indigo .theme-bg-500 { background-color: #6366f1; }
        .theme-indigo .theme-bg-600 { background-color: #4f46e5; }
        .theme-indigo .theme-text { color: #6366f1; }
        .theme-indigo .dark .theme-text { color: #818cf8; }
        .theme-indigo .theme-ring { ring-color: #6366f1; }
        
        .theme-teal .theme-gradient { background-image: linear-gradient(to right, #2dd4bf, #0d9488); }
        .theme-teal .theme-bg-500 { background-color: #2dd4bf; }
        .theme-teal .theme-bg-600 { background-color: #0d9488; }
        .theme-teal .theme-text { color: #2dd4bf; }
        .theme-teal .dark .theme-text { color: #5eead4; }
        .theme-teal .theme-ring { ring-color: #2dd4bf; }
        
        .theme-rose .theme-gradient { background-image: linear-gradient(to right, #fb7185, #e11d48); }
        .theme-rose .theme-bg-500 { background-color: #fb7185; }
        .theme-rose .theme-bg-600 { background-color: #e11d48; }
        .theme-rose .theme-text { color: #fb7185; }
        .theme-rose .dark .theme-text { color: #fda4af; }
        .theme-rose .theme-ring { ring-color: #fb7185; }
        
        .theme-amber .theme-gradient { background-image: linear-gradient(to right, #fbbf24, #d97706); }
        .theme-amber .theme-bg-500 { background-color: #fbbf24; }
        .theme-amber .theme-bg-600 { background-color: #d97706; }
        .theme-amber .theme-text { color: #fbbf24; }
        .theme-amber .dark .theme-text { color: #fcd34d; }
        .theme-amber .theme-ring { ring-color: #fbbf24; }
    </style>
</head>
<body class="bg-gray-200 dark:bg-gray-900 flex justify-center items-center min-h-screen p-4">

    <!-- App Container -->
    <div id="app-container" class="main-container bg-white dark:bg-gray-800 shadow-2xl rounded-3xl overflow-hidden w-full flex flex-col relative theme-indigo">
        <!-- School logo file input (hidden) -->
        <input type="file" id="school-logo-upload" class="hidden" accept="image/*">
        <!-- Header -->
        <header class="theme-gradient p-4 flex justify-between items-center text-white shadow-md z-10 flex-shrink-0">
            <h1 id="header-school-name" class="text-xl font-bold tracking-wider">Creative School of Art</h1>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white">
                <i data-lucide="more-vertical"></i>
            </button>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow overflow-y-auto custom-scrollbar relative">
            
            <div id="page-student-profile" class="page active p-4 animate-slide-up">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800 dark:text-white">Student Profile</h2><div class="relative"><input id="search-student" type="text" placeholder="Search..." class="pl-8 pr-4 py-2 w-full max-w-xs bg-gray-100 dark:bg-gray-700 dark:text-white border-transparent rounded-full focus:outline-none focus:ring-2 theme-ring"><i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i></div></div><div id="student-list" class="space-y-3"></div>
            </div>

            <div id="page-student-batch" class="page p-4 animate-slide-up">
                 <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800 dark:text-white">Student Batch</h2><div class="relative"><input id="search-batch" type="text" placeholder="Search..." class="pl-8 pr-4 py-2 w-full max-w-xs bg-gray-100 dark:bg-gray-700 dark:text-white border-transparent rounded-full focus:outline-none focus:ring-2 theme-ring"><i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i></div></div><div id="batch-list" class="space-y-3"></div>
            </div>

            <div id="page-student-fees" class="page p-4 animate-slide-up">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800 dark:text-white">Student Fees</h2><div class="relative"><input id="search-fees" type="text" placeholder="Search..." class="pl-8 pr-4 py-2 w-full max-w-xs bg-gray-100 dark:bg-gray-700 dark:text-white border-transparent rounded-full focus:outline-none focus:ring-2 theme-ring"><i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i></div></div><div id="fees-list" class="space-y-3"></div>
            </div>

            <div id="page-detail-view" class="page p-4 animate-slide-up">
                <button class="back-btn mb-4 flex items-center gap-2 theme-text font-semibold hover:underline"><i data-lucide="arrow-left" class="w-5 h-5"></i> Back</button>
                <div id="detail-content"></div>
            </div>
            
            <div id="page-settings" class="page p-4 animate-slide-up">
                 <button class="back-btn mb-4 flex items-center gap-2 theme-text font-semibold hover:underline"><i data-lucide="arrow-left" class="w-5 h-5"></i> Back</button>
                <div class="space-y-6">
                    <div><h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3">School Profile</h3><div id="school-profile-content" class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow space-y-4"></div></div>
                    <div><h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3">Total Income</h3><div id="income-content" class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow space-y-2"></div></div>
                </div>
            </div>
            
            <button id="fab-add-student" class="absolute bottom-24 right-6 theme-gradient text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transform hover:scale-110 transition-transform"><i data-lucide="user-plus"></i></button>
            <button id="fab-add-batch" class="absolute bottom-24 right-6 theme-gradient text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transform hover:scale-110 transition-transform hidden"><i data-lucide="plus"></i></button>
        </main>
        
        <nav class="flex-shrink-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex justify-around shadow-inner">
            <button data-page="page-student-profile" class="nav-btn flex-1 p-3 text-center theme-text"><i data-lucide="users" class="mx-auto w-6 h-6"></i><span class="text-xs">Profile</span></button>
            <button data-page="page-student-batch" class="nav-btn flex-1 p-3 text-center text-gray-500 dark:text-gray-400"><i data-lucide="layers" class="mx-auto w-6 h-6"></i><span class="text-xs">Batch</span></button>
            <button data-page="page-student-fees" class="nav-btn flex-1 p-3 text-center text-gray-500 dark:text-gray-400"><i data-lucide="indian-rupee" class="mx-auto w-6 h-6"></i><span class="text-xs">Fees</span></button>
        </nav>

        <div id="settings-menu" class="hidden absolute top-16 right-4 bg-white dark:bg-gray-700 rounded-lg shadow-xl w-48 z-20 animate-fade-in">
            <a href="#" id="school-profile-link" class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">School Profile</a>
            <div class="flex items-center justify-between px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600"><span>Dark Mode</span><label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" id="dark-mode-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
            <div class="border-t border-gray-200 dark:border-gray-600"></div>
            <a href="#" id="change-theme-link" class="block px-4 py-2 text-gray-800 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Change Theme</a>
        </div>
    </div>
    
    <div id="modal-backdrop" class="modal-backdrop hidden animate-fade-in"></div>
    <div id="modal-container" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto custom-scrollbar">
        <div class="flex justify-between items-center mb-4"><h3 id="modal-title" class="text-xl font-bold text-gray-800 dark:text-white"></h3><button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-white"><i data-lucide="x"></i></button></div>
        <div id="modal-content"></div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let state = {
                schoolProfile: { logo: 'https://placehold.co/80x80/a78bfa/ffffff?text=Logo', name: 'Creative School of Art', principal: 'John Doe', code: 'CSA12345', address: '123 Art Lane, Creativity City' },
                students: [
                    { id: 1, name: 'Ranit Das', photo: 'https://placehold.co/100x100/c7d2fe/3730a3?text=RD', fatherName: 'Tapan Das', motherName: 'Rita Das', class: 'V', age: 10, mobile: '9876543210', address: 'Kolkata, WB', batchId: 1, feesAmount: 500 },
                    { id: 2, name: 'Joy Biswas', photo: 'https://placehold.co/100x100/ddd6fe/4338ca?text=JB', fatherName: 'Amit Biswas', motherName: 'Soma Biswas', class: 'VI', age: 11, mobile: '9876543211', address: 'Durgapur, WB', batchId: 1, feesAmount: 600 },
                    { id: 3, name: 'Aku Singh', photo: 'https://placehold.co/100x100/e9d5ff/5b21b6?text=AS', fatherName: 'Rakesh Singh', motherName: 'Priya Singh', class: 'V', age: 10, mobile: '9876543212', address: 'Asansol, WB', batchId: 2, feesAmount: 500 },
                ],
                batches: [ { id: 1, name: 'Batch No 1', studentIds: [1, 2] }, { id: 2, name: 'Batch No 2', studentIds: [3] } ],
                fees: {
                    '1': {
                        '2025': {
                            '0': 'paid', '1': 'paid', '2': 'due', '3': 'normal', '4': 'normal', '5': 'normal', '6': 'normal', '7': 'normal', '8': 'normal', '9': 'normal', '10': 'normal', '11': 'normal'
                        }
                    },
                    '2': {
                        '2025': {
                            '0': 'paid', '1': 'paid', '2': 'paid', '3': 'paid', '4': 'due', '5': 'normal', '6': 'normal', '7': 'normal', '8': 'normal', '9': 'normal', '10': 'normal', '11': 'normal'
                        }
                    }
                },
                nextStudentId: 4,
                nextBatchId: 3,
                currentTheme: 'indigo'
            };

            const currentPage = { id: 'page-student-profile', history: ['page-student-profile'] };
            const FEE_STATUSES = ['normal', 'paid', 'due'];
            const THEMES = {
                indigo: { name: 'Indigo', class: 'theme-indigo', color: '#6366f1' },
                teal: { name: 'Teal', class: 'theme-teal', color: '#2dd4bf' },
                rose: { name: 'Rose', class: 'theme-rose', color: '#fb7185' },
                amber: { name: 'Amber', class: 'theme-amber', color: '#fbbf24' },
            };
            const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const currentYear = new Date().getFullYear();

            // --- RENDER FUNCTIONS ---
            const sortAlphabetically = (a, b) => a.name.localeCompare(b.name);

            function renderAll() {
                renderStudentList(document.getElementById('search-student').value);
                renderBatchList(document.getElementById('search-batch').value);
                renderFeesList(document.getElementById('search-fees').value);
                renderSchoolProfile();
                renderIncomeContent();
                document.getElementById('header-school-name').textContent = state.schoolProfile.name;
            }

            function renderStudentList(filter = '') {
                const listEl = document.getElementById('student-list');
                const filtered = state.students.filter(s => s.name.toLowerCase().includes(filter.toLowerCase())).sort(sortAlphabetically);
                listEl.innerHTML = filtered.length ? filtered.map(s => `
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md flex items-center space-x-4 hover:shadow-lg transition-shadow">
                        <img src="${s.photo}" alt="${s.name}" class="w-14 h-14 rounded-full object-cover">
                        <div class="flex-grow cursor-pointer" data-action="view" data-id="${s.id}">
                            <p class="font-bold text-lg text-gray-800 dark:text-white">${s.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Class: ${s.class}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-action="edit" data-id="${s.id}" class="p-2 text-yellow-500 hover:text-yellow-600"><i data-lucide="edit" class="w-5 h-5"></i></button>
                            <button data-action="delete" data-id="${s.id}" class="p-2 text-red-500 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>`).join('') : `<p class="text-center text-gray-500 dark:text-gray-400 mt-8">No students found.</p>`;
                
                listEl.querySelectorAll('[data-id]').forEach(el => el.addEventListener('click', (e) => {
                    const actionTarget = e.target.closest('[data-action]');
                    if (!actionTarget) return;
                    const action = actionTarget.dataset.action;
                    const id = parseInt(actionTarget.dataset.id);
                    if (action === 'edit') handleStudentForm(id);
                    else if (action === 'delete') deleteStudent(id);
                    else if (action === 'view') showStudentDetail(id);
                }));
                lucide.createIcons();
            }

            function renderBatchList(filter = '') {
                const listEl = document.getElementById('batch-list');
                const filtered = state.batches.filter(b => b.name.toLowerCase().includes(filter.toLowerCase())).sort(sortAlphabetically);
                listEl.innerHTML = filtered.length ? filtered.map(b => {
                    const studentCount = b.studentIds.length;
                    return `
                        <div data-id="${b.id}" class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition-shadow" data-action="view-batch">
                            <div class="flex justify-between items-center mb-2">
                                <p class="font-bold text-lg text-gray-800 dark:text-white">${b.name}</p>
                                <span class="text-sm text-gray-500 dark:text-gray-400">${studentCount} Students</span>
                            </div>
                            <div class="flex justify-end mt-2 space-x-2">
                                <button data-action="edit-batch" data-id="${b.id}" class="p-2 text-yellow-500 hover:text-yellow-600"><i data-lucide="edit" class="w-5 h-5"></i></button>
                                <button data-action="delete-batch" data-id="${b.id}" class="p-2 text-red-500 hover:text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                            </div>
                        </div>`;
                }).join('') : `<p class="text-center text-gray-500 dark:text-gray-400 mt-8">No batches found.</p>`;
                
                listEl.querySelectorAll('[data-action]').forEach(el => el.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    const id = parseInt(e.currentTarget.dataset.id);
                    if (action === 'edit-batch') handleBatchForm(id);
                    else if (action === 'delete-batch') deleteBatch(id);
                    else if (action === 'view-batch') showBatchDetail(id);
                }));
                lucide.createIcons();
            }
            
            function showBatchDetail(batchId) {
                const batch = state.batches.find(b => b.id === batchId);
                const studentsInBatch = state.students.filter(s => batch.studentIds.includes(s.id)).sort(sortAlphabetically);
                document.getElementById('detail-content').innerHTML = `
                    <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-lg">
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Students in ${batch.name}</h3>
                        ${studentsInBatch.length > 0 ? `
                            <ul class="space-y-3">
                                ${studentsInBatch.map(s => `
                                    <li class="p-3 bg-gray-100 dark:bg-gray-600 rounded-lg shadow-sm flex items-center gap-4">
                                        <img src="${s.photo}" alt="${s.name}" class="w-10 h-10 rounded-full object-cover">
                                        <div>
                                            <p class="font-semibold text-gray-800 dark:text-white">${s.name}</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Class: ${s.class}</p>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : `<p class="text-center text-gray-500 dark:text-gray-400">No students found in this batch.</p>`}
                    </div>`;
                switchPage('page-detail-view');
                lucide.createIcons();
            }

            function renderFeesList(filter = '') {
                const listEl = document.getElementById('fees-list');
                const filtered = state.students.filter(s => s.name.toLowerCase().includes(filter.toLowerCase())).sort(sortAlphabetically);
                listEl.innerHTML = filtered.length ? filtered.map(s => `
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md flex items-center space-x-4 hover:shadow-lg transition-shadow cursor-pointer" data-action="view-fees" data-id="${s.id}">
                        <img src="${s.photo}" alt="${s.name}" class="w-14 h-14 rounded-full object-cover">
                        <div class="flex-grow">
                            <p class="font-bold text-lg text-gray-800 dark:text-white">${s.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Class: ${s.class} | Fees: ₹${s.feesAmount}/month</p>
                        </div>
                    </div>`).join('') : `<p class="text-center text-gray-500 dark:text-gray-400 mt-8">No students found.</p>`;
                
                listEl.querySelectorAll('[data-action]').forEach(el => el.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    showFeesStatement(id);
                }));
            }
            
            function renderSchoolProfile() {
                const { logo, name, principal, code, address } = state.schoolProfile;
                document.getElementById('school-profile-content').innerHTML = `
                    <div class="flex flex-col sm:flex-row items-center space-x-0 sm:space-x-4">
                        <div class="relative group mb-4 sm:mb-0">
                            <img src="${logo}" alt="School Logo" id="school-logo-img" class="w-20 h-20 rounded-full object-cover border-4 border-gray-300 cursor-pointer">
                            <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="document.getElementById('school-logo-upload').click()">
                                <i data-lucide="camera" class="text-white w-8 h-8"></i>
                            </div>
                        </div>
                        <button id="edit-school-profile-btn" class="w-full theme-bg-500 hover:theme-bg-600 text-white py-2 rounded-lg">Edit Profile</button>
                    </div>
                    <p class="dark:text-gray-200"><strong>School:</strong> ${name}</p>
                    <p class="dark:text-gray-200"><strong>Principal:</strong> ${principal}</p>
                    <p class="dark:text-gray-200"><strong>Code:</strong> ${code}</p>
                    <p class="dark:text-gray-200"><strong>Address:</strong> ${address}</p>`;
                document.getElementById('edit-school-profile-btn').addEventListener('click', handleSchoolProfileForm);
                document.getElementById('school-logo-img').addEventListener('click', () => document.getElementById('school-logo-upload').click());
                document.getElementById('school-logo-upload').addEventListener('change', (e) => handleImageUpload(e, 'schoolProfile'));
                lucide.createIcons();
            }
            
            function renderIncomeContent() {
                const totalDue = state.students.reduce((acc, student) => {
                    const studentFees = state.fees[student.id] || {};
                    const totalDueMonths = Object.values(studentFees).reduce((yearAcc, yearMonths) => {
                        const dueCount = Object.values(yearMonths).filter(status => status === 'due').length;
                        return yearAcc + dueCount;
                    }, 0);
                    return acc + (totalDueMonths * student.feesAmount);
                }, 0);

                const totalIncome = state.students.reduce((acc, student) => {
                    const studentFees = state.fees[student.id] || {};
                    const totalPaidMonths = Object.values(studentFees).reduce((yearAcc, yearMonths) => {
                        const paidCount = Object.values(yearMonths).filter(status => status === 'paid').length;
                        return yearAcc + paidCount;
                    }, 0);
                    return acc + (totalPaidMonths * student.feesAmount);
                }, 0);

                const dueStudentsCount = state.students.filter(s => {
                    const studentFees = state.fees[s.id] || {};
                    return Object.values(studentFees).some(yearMonths => Object.values(yearMonths).some(status => status === 'due'));
                }).length;
                
                const dueStudentsBtn = dueStudentsCount > 0 ? `<button id="view-due-students-btn" class="w-full mt-2 py-2 px-4 theme-bg-500 hover:theme-bg-600 text-white rounded-lg transition-colors">View Due Students</button>` : `<p class="text-center text-gray-500 dark:text-gray-400 text-sm mt-2">No students have due fees.</p>`;

                document.getElementById('income-content').innerHTML = `
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-600 p-3 rounded-lg"><span class="font-semibold text-gray-700 dark:text-gray-300">Total Income:</span> <span class="font-bold text-green-500">₹${totalIncome}</span></div>
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-600 p-3 rounded-lg"><span class="font-semibold text-gray-700 dark:text-gray-300">Total Due:</span> <span class="font-bold text-red-500">₹${totalDue}</span></div>
                    ${dueStudentsBtn}`;
                
                if (dueStudentsCount > 0) {
                     document.getElementById('view-due-students-btn').addEventListener('click', showDueStudentsModal);
                }
            }
            
            function showDueStudentsModal() {
                const dueStudents = state.students.filter(s => {
                    const studentFees = state.fees[s.id] || {};
                    return Object.values(studentFees).some(yearMonths => Object.values(yearMonths).some(status => status === 'due'));
                }).sort(sortAlphabetically);

                document.getElementById('modal-title').textContent = 'Due Fees List';
                document.getElementById('modal-content').innerHTML = `
                    <ul class="space-y-3">
                        ${dueStudents.map(s => {
                            const totalDueMonths = Object.values(state.fees[s.id]).reduce((yearAcc, yearMonths) => {
                                const dueCount = Object.values(yearMonths).filter(status => status === 'due').length;
                                return yearAcc + dueCount;
                            }, 0);
                            const totalDueAmount = totalDueMonths * s.feesAmount;
                            return `
                                <li class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                                    <div>
                                        <p class="font-semibold text-gray-800 dark:text-white">${s.name}</p>
                                        <p class="text-sm text-red-500">Due: ₹${totalDueAmount}</p>
                                    </div>
                                    <button data-action="mark-paid" data-id="${s.id}" class="py-1 px-3 bg-green-500 hover:bg-green-600 text-white rounded-lg">Mark as Paid</button>
                                </li>`;
                        }).join('')}
                    </ul>`;
                
                document.querySelectorAll('[data-action="mark-paid"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const studentId = parseInt(e.currentTarget.dataset.id);
                        markAllDueAsPaid(studentId);
                    });
                });
                
                showModal();
            }

            // --- DETAIL VIEW RENDERERS ---
            function showStudentDetail(studentId) {
                const student = state.students.find(s => s.id === studentId);
                const batch = state.batches.find(b => b.id === student.batchId);
                document.getElementById('detail-content').innerHTML = `
                    <div class="id-card-bg dark:bg-gray-700 shadow-xl rounded-2xl p-6 space-y-4 max-w-md mx-auto">
                        <div class="flex flex-col items-center text-center">
                            <div class="relative group">
                                <img src="${student.photo}" alt="${student.name}" id="student-detail-photo" class="w-28 h-28 rounded-full object-cover border-4 border-white dark:border-gray-500 shadow-lg">
                                <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="document.getElementById('student-detail-photo-upload').click()">
                                    <i data-lucide="camera" class="text-white w-8 h-8"></i>
                                </div>
                                <input type="file" id="student-detail-photo-upload" class="hidden" accept="image/*" data-id="${student.id}">
                            </div>
                            <h3 class="text-3xl font-bold text-gray-800 dark:text-white tracking-wide mt-4">${student.name}</h3><p class="theme-text font-medium">Student ID: CSA-${String(student.id).padStart(4,'0')}</p></div><div class="border-t border-gray-300 dark:border-gray-600 my-4"></div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-gray-700 dark:text-gray-300"><p><strong>Father:</strong> ${student.fatherName}</p><p><strong>Mother:</strong> ${student.motherName}</p><p><strong>Class:</strong> ${student.class}</p><p><strong>Age:</strong> ${student.age}</p><p><strong>Mobile:</strong> ${student.mobile}</p><p><strong>Batch:</strong> ${batch ? batch.name : 'N/A'}</p><p class="col-span-2"><strong>Address:</strong> ${student.address}</p><p class="col-span-2"><strong>Fees:</strong> ₹${student.feesAmount}/month</p></div>
                        <div class="flex justify-end space-x-2 mt-4"><button class="p-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600" data-action="edit"><i data-lucide="edit" class="w-5 h-5"></i></button><button class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600" data-action="delete"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>
                    </div>`;
                switchPage('page-detail-view');
                lucide.createIcons();
                document.querySelector('#detail-content [data-action="edit"]').addEventListener('click', () => handleStudentForm(studentId));
                document.querySelector('#detail-content [data-action="delete"]').addEventListener('click', () => deleteStudent(studentId));
                document.getElementById('student-detail-photo-upload').addEventListener('change', (e) => handleImageUpload(e, 'student', studentId));
            }

            function showFeesStatement(studentId) {
                const student = state.students.find(s => s.id === studentId);
                document.getElementById('modal-title').textContent = `${student.name}'s Monthly Fees`;
                
                let options = '';
                for (let y = 2025; y <= 2040; y++) {
                    options += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
                }

                document.getElementById('modal-content').innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-semibold dark:text-gray-200">Monthly Fees: ₹${student.feesAmount}</p>
                        <select id="fee-year-select" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring">
                            ${options}
                        </select>
                    </div>
                    <div id="monthly-statement" class="space-y-3"></div>`;
                
                function renderStatement(year) {
                    const statementEl = document.getElementById('monthly-statement');
                    const studentFeesByYear = state.fees[student.id] || {};
                    const yearFees = studentFeesByYear[year] || {};
                    statementEl.innerHTML = MONTHS.map((month, index) => {
                        const status = yearFees[index] || 'normal';
                        const statusClass = `status-${status}`;
                        return `
                            <div class="flex justify-between items-center p-3 rounded-lg shadow-sm bg-gray-100 dark:bg-gray-700">
                                <span class="font-semibold text-gray-800 dark:text-white">${month}</span>
                                <div class="flex items-center gap-2">
                                    <span class="px-3 py-1 text-xs rounded-full font-semibold ${statusClass}">${status.toUpperCase()}</span>
                                    <button data-status-action="toggle-status" data-month-index="${index}" data-year="${year}" data-student-id="${student.id}" class="p-1 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-white"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                                </div>
                            </div>`;
                    }).join('');
                    lucide.createIcons();
                    document.querySelectorAll('[data-status-action]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const studentId = parseInt(e.currentTarget.dataset.studentId);
                            const year = parseInt(e.currentTarget.dataset.year);
                            const monthIndex = parseInt(e.currentTarget.dataset.monthIndex);
                            toggleFeeStatus(studentId, year, monthIndex);
                        });
                    });
                }
                
                document.getElementById('fee-year-select').addEventListener('change', (e) => {
                    renderStatement(parseInt(e.target.value));
                });

                showModal();
                renderStatement(currentYear);
            }

            // --- FORM HANDLERS & DATA MODIFIERS ---
            function handleStudentForm(id = null) {
                const isNew = id === null;
                const student = isNew ? {} : state.students.find(s => s.id === id);
                document.getElementById('modal-title').textContent = isNew ? 'Add New Student' : 'Edit Student';
                document.getElementById('modal-content').innerHTML = `
                    <form id="student-form" class="space-y-4">
                        <input type="hidden" name="id" value="${student.id || ''}">
                        <div class="flex flex-col items-center gap-4">
                            <img id="form-photo-preview" src="${student.photo || 'https://placehold.co/100x100/A0AEC0/ffffff?text=User'}" class="w-24 h-24 rounded-full object-cover border-4 border-gray-300 dark:border-gray-600">
                            <label class="w-full text-center py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg cursor-pointer">
                                Upload Photo
                                <input type="file" id="form-photo-upload" class="hidden" accept="image/*">
                            </label>
                        </div>
                        <input type="hidden" name="photo" value="${student.photo || ''}" id="form-photo-value">
                        <input name="name" type="text" placeholder="Name" value="${student.name || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="fatherName" type="text" placeholder="Father's Name" value="${student.fatherName || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="motherName" type="text" placeholder="Mother's Name" value="${student.motherName || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="class" type="text" placeholder="Class" value="${student.class || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="age" type="number" placeholder="Age" value="${student.age || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="mobile" type="tel" placeholder="Mobile Number" value="${student.mobile || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="address" type="text" placeholder="Address" value="${student.address || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <select name="batchId" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                            <option value="">Select Batch</option>
                            ${state.batches.map(b => `<option value="${b.id}" ${student.batchId === b.id ? 'selected' : ''}>${b.name}</option>`).join('')}
                        </select>
                        <input name="feesAmount" type="number" placeholder="Fees Amount" value="${student.feesAmount || ''}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <button type="submit" class="w-full theme-bg-500 hover:theme-bg-600 text-white font-semibold py-3 rounded-lg transition-colors">Save</button>
                    </form>`;
                showModal();
                const formEl = document.getElementById('student-form');
                const photoInput = document.getElementById('form-photo-upload');
                photoInput.addEventListener('change', (e) => handleImageUpload(e, 'form-photo'));
                formEl.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const newStudent = Object.fromEntries(formData.entries());
                    newStudent.id = newStudent.id ? parseInt(newStudent.id) : state.nextStudentId++;
                    newStudent.batchId = parseInt(newStudent.batchId);
                    newStudent.age = parseInt(newStudent.age);
                    newStudent.feesAmount = parseInt(newStudent.feesAmount);
                    
                    const oldBatch = state.batches.find(b => b.studentIds.includes(newStudent.id));
                    if (oldBatch) {
                        oldBatch.studentIds = oldBatch.studentIds.filter(sId => sId !== newStudent.id);
                    }
                    
                    const newBatch = state.batches.find(b => b.id === newStudent.batchId);
                    if (newBatch && !newBatch.studentIds.includes(newStudent.id)) {
                        newBatch.studentIds.push(newStudent.id);
                    }

                    if (isNew) {
                        state.students.push(newStudent);
                    } else {
                        const index = state.students.findIndex(s => s.id === newStudent.id);
                        if (index !== -1) state.students[index] = newStudent;
                    }
                    saveState();
                    hideModal();
                    renderAll();
                });
            }

            function handleSchoolProfileForm() {
                const { name, principal, code, address } = state.schoolProfile;
                document.getElementById('modal-title').textContent = 'Edit School Profile';
                document.getElementById('modal-content').innerHTML = `
                    <form id="school-profile-form" class="space-y-4">
                        <input name="name" type="text" placeholder="School Name" value="${name}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="principal" type="text" placeholder="Principal's Name" value="${principal}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="code" type="text" placeholder="Centre Code" value="${code}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <input name="address" type="text" placeholder="Address" value="${address}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <button type="submit" class="w-full theme-bg-500 hover:theme-bg-600 text-white font-semibold py-3 rounded-lg transition-colors">Save</button>
                    </form>`;
                showModal();
                document.getElementById('school-profile-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    state.schoolProfile.name = formData.get('name');
                    state.schoolProfile.principal = formData.get('principal');
                    state.schoolProfile.code = formData.get('code');
                    state.schoolProfile.address = formData.get('address');
                    saveState();
                    hideModal();
                    renderAll();
                    switchPage('page-settings');
                });
            }

            function handleBatchForm(id = null) {
                const isNew = id === null;
                const batch = isNew ? { id: state.nextBatchId, name: '', studentIds: [] } : state.batches.find(b => b.id === id);
                document.getElementById('modal-title').textContent = isNew ? 'Add New Batch' : `Edit Batch: ${batch.name}`;
                document.getElementById('modal-content').innerHTML = `
                    <form id="batch-form" class="space-y-4">
                        <input type="hidden" name="id" value="${batch.id}">
                        <input name="name" type="text" placeholder="Batch Name" value="${batch.name}" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white border-none focus:outline-none focus:ring-2 theme-ring" required>
                        <div class="space-y-2">
                            <p class="font-semibold dark:text-gray-200">Select Students:</p>
                            <div class="space-y-1 max-h-48 overflow-y-auto custom-scrollbar p-2 rounded-lg bg-gray-100 dark:bg-gray-700">
                                ${state.students.map(s => `
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" name="studentId" value="${s.id}" ${batch.studentIds.includes(s.id) ? 'checked' : ''} class="rounded text-indigo-600 focus:ring-indigo-500 dark:bg-gray-500">
                                        <span class="text-gray-800 dark:text-gray-200">${s.name} (${s.class})</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <button type="submit" class="w-full theme-bg-500 hover:theme-bg-600 text-white font-semibold py-3 rounded-lg transition-colors">Save</button>
                    </form>`;
                showModal();
                document.getElementById('batch-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const updatedBatch = {
                        id: parseInt(formData.get('id')),
                        name: formData.get('name'),
                        studentIds: formData.getAll('studentId').map(Number)
                    };
                    
                    if (isNew) {
                        state.batches.push(updatedBatch);
                        state.nextBatchId++;
                    } else {
                        const index = state.batches.findIndex(b => b.id === updatedBatch.id);
                        if (index !== -1) state.batches[index] = updatedBatch;
                    }
                    
                    state.students.forEach(s => {
                        if (updatedBatch.studentIds.includes(s.id)) {
                            s.batchId = updatedBatch.id;
                        } else if (s.batchId === updatedBatch.id) {
                            s.batchId = null;
                        }
                    });

                    saveState();
                    hideModal();
                    renderAll();
                });
            }

            function handleImageUpload(event, targetType, studentId = null) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Url = e.target.result;
                        if (targetType === 'schoolProfile') {
                            document.getElementById('school-logo-img').src = base64Url;
                            state.schoolProfile.logo = base64Url;
                        } else if (targetType === 'student') {
                            const student = state.students.find(s => s.id === studentId);
                            if (student) {
                                student.photo = base64Url;
                                document.getElementById('student-detail-photo').src = base64Url;
                            }
                        } else if (targetType === 'form-photo') {
                            document.getElementById('form-photo-preview').src = base64Url;
                            document.getElementById('form-photo-value').value = base64Url;
                        }
                        saveState();
                    };
                    reader.readAsDataURL(file);
                }
            }

            function toggleFeeStatus(studentId, year, monthIndex) {
                if (!state.fees[studentId]) state.fees[studentId] = {};
                if (!state.fees[studentId][year]) state.fees[studentId][year] = {};
                
                const currentStatus = state.fees[studentId][year][monthIndex] || 'normal';
                const nextStatusIndex = (FEE_STATUSES.indexOf(currentStatus) + 1) % FEE_STATUSES.length;
                state.fees[studentId][year][monthIndex] = FEE_STATUSES[nextStatusIndex];
                
                saveState();
                renderAll();
                showFeesStatement(studentId); // Re-render the modal to show the change
            }

            function markAllDueAsPaid(studentId) {
                if (!state.fees[studentId]) return;
                
                Object.values(state.fees[studentId]).forEach(yearMonths => {
                    for (const monthIndex in yearMonths) {
                        if (yearMonths[monthIndex] === 'due') {
                            yearMonths[monthIndex] = 'paid';
                        }
                    }
                });
                
                saveState();
                renderAll();
                showDueStudentsModal(); // Re-render the due students modal
            }

            function deleteStudent(id) {
                state.students = state.students.filter(s => s.id !== id);
                state.batches.forEach(b => {
                    b.studentIds = b.studentIds.filter(sId => sId !== id);
                });
                delete state.fees[id];
                saveState();
                hideModal();
                renderAll();
            }

            function deleteBatch(id) {
                state.batches = state.batches.filter(b => b.id !== id);
                state.students.forEach(s => {
                    if (s.batchId === id) {
                        s.batchId = null;
                    }
                });
                saveState();
                renderAll();
            }

            // --- PAGE & UI LOGIC ---
            function switchPage(pageId) {
                const pages = document.querySelectorAll('.page');
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                const fabAddStudent = document.getElementById('fab-add-student');
                const fabAddBatch = document.getElementById('fab-add-batch');
                fabAddStudent.classList.toggle('hidden', pageId !== 'page-student-profile');
                fabAddBatch.classList.toggle('hidden', pageId !== 'page-student-batch');
                
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    if (btn.dataset.page === pageId) {
                        btn.classList.add('theme-text');
                        btn.classList.remove('text-gray-500', 'dark:text-gray-400');
                    } else {
                        btn.classList.remove('theme-text');
                        btn.classList.add('text-gray-500', 'dark:text-gray-400');
                    }
                });
                
                if (currentPage.id !== pageId) {
                    currentPage.history.push(pageId);
                    currentPage.id = pageId;
                }
            }

            function showModal() {
                document.getElementById('modal-backdrop').classList.remove('hidden');
                document.getElementById('modal-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('blur');
            }
            
            function hideModal() {
                document.getElementById('modal-backdrop').classList.add('hidden');
                document.getElementById('modal-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('blur');
            }

            function toggleDarkMode() {
                document.documentElement.classList.toggle('dark', document.getElementById('dark-mode-toggle').checked);
            }

            function switchTheme(themeKey) {
                const app = document.getElementById('app-container');
                Object.values(THEMES).forEach(t => app.classList.remove(t.class));
                app.classList.add(THEMES[themeKey].class);
                state.currentTheme = themeKey;
                saveState();
            }

            function createThemeSelector() {
                 document.getElementById('modal-title').textContent = 'Change Theme';
                 document.getElementById('modal-content').innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        ${Object.keys(THEMES).map(key => `
                            <button data-theme="${key}" class="theme-option p-4 rounded-xl shadow-lg flex flex-col items-center justify-center transition-transform hover:scale-105 theme-${key}">
                                <div class="w-10 h-10 rounded-full theme-bg-500 mb-2"></div>
                                <span class="text-sm font-semibold text-gray-800 dark:text-gray-200">${THEMES[key].name}</span>
                            </button>
                        `).join('')}
                    </div>`;
                showModal();
                document.querySelectorAll('.theme-option').forEach(btn => {
                    btn.addEventListener('click', () => {
                        switchTheme(btn.dataset.theme);
                        hideModal();
                    });
                });
            }

            // --- LOCAL STORAGE (for state persistence) ---
            function saveState() {
                try {
                    localStorage.setItem('artSchoolState', JSON.stringify(state));
                } catch (e) {
                    console.error("Could not save state to local storage", e);
                }
            }
            
            function loadState() {
                try {
                    const savedState = localStorage.getItem('artSchoolState');
                    if (savedState) {
                        state = JSON.parse(savedState);
                    }
                } catch (e) {
                    console.error("Could not load state from local storage", e);
                }
            }

            // --- INITIALIZATION ---
            function initialize() {
                loadState();
                switchTheme(state.currentTheme);
                renderAll();
                
                // Set up event listeners for navigation and UI controls
                document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => {
                    switchPage(btn.dataset.page);
                    document.getElementById('settings-menu').classList.add('hidden');
                }));
                document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', () => {
                     if (currentPage.history.length > 1) {
                         currentPage.history.pop();
                         switchPage(currentPage.history[currentPage.history.length - 1]);
                     }
                }));
                
                document.getElementById('settings-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = document.getElementById('settings-menu');
                    menu.classList.toggle('hidden');
                });
                document.getElementById('modal-close-btn').addEventListener('click', hideModal);
                
                document.getElementById('school-profile-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPage('page-settings');
                    document.getElementById('settings-menu').classList.add('hidden');
                });
                document.getElementById('change-theme-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('settings-menu').classList.add('hidden');
                    createThemeSelector();
                });
                document.getElementById('dark-mode-toggle').addEventListener('change', toggleDarkMode);
                if (localStorage.getItem('theme') === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.getElementById('dark-mode-toggle').checked = true;
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('dark-mode-toggle').checked = false;
                }
                
                document.getElementById('fab-add-student').addEventListener('click', () => handleStudentForm());
                document.getElementById('fab-add-batch').addEventListener('click', () => handleBatchForm());
                
                // Search functionality
                document.getElementById('search-student').addEventListener('input', (e) => renderStudentList(e.target.value));
                document.getElementById('search-batch').addEventListener('input', (e) => renderBatchList(e.target.value));
                document.getElementById('search-fees').addEventListener('input', (e) => renderFeesList(e.target.value));
                
                lucide.createIcons();
            }
            
            initialize();
        });
    </script>
</body>
</html>